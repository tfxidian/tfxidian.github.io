---
title:  DMA and iommu
date: 2021-08-26 9:55:50
tags: DMA, IOMMU, attack
layout: post
---

## Direct Memory Access (DMA)



![](https://github.com/tfxidian/tfxidian.github.io/raw/master/pic/DMA.PNG)





## Intel VT-d – IOMMU

### what is IOMMU

- IOMMU = I/O Memory Management Unit
- “Virtualization Technology for Directed I/O”(VT-d) 

- Connects a DMA capable I/O bus to the main memory 
  - IOMMU maps bus-address space to the physical address space. 
  -  IOMMU is the bus-address mapper, just as MMU is the virtual address mapper 
  - IOMMU and MMU have many of the same benefits and costs.
- Mapping by pages of 4KB, 2MB or 1GB

### Why have IOMMU?

- Bus address length != Physical address size
- Can efficiently map a contiguous bus address space to non-contiguous main-memory\
- Protection: a device cannot read or write memory that has not been explicitly mapped for it
- Virtualization: guest OS can use h/w that is not virtualization aware

## IOMMU and DMA



- Virtual address “X” is generated by kmalloc() 
- VM system maps “X” to a physaddr “Y” 
  - But a driver cannot set up DMA to the bus address for “Y” without the help of IOMMU 
- IOMMU translates “Z” to “Y” 
- To do DMA, driver can call dma_map_single() with “X” to set up the needed IOMMU for “Z